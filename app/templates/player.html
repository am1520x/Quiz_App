<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Player â€“ {{ session_id }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <h1>Join Session {{ session_id }}</h1>
  <input id="name" placeholder="Team name" />
  <button id="join">Join</button>

  <div class="flex justify-center py-4">
    <img src="/static/Logo.png" alt="Institute Bar Logo" class="h-16">
  </div>

  <div id="game" style="display:none;">
    <h2 id="teamlabel"></h2>
    <p id="question-counter"></p>
    <button id="buzz"
      class="w-full h-64 text-5xl font-bold rounded-2xl transition-colors duration-300"
      disabled>
      BUZZ!
    </button>

    <p id="hint">Waitingâ€¦</p>

    <div class="h-40 overflow-y-auto bg-black text-white p-2 rounded">
      <h3 class="text-orange-500 font-bold">âš¡ Fastest Buzzers</h3>
      <ol id="buzz-leaderboard"></ol>

      <h3 class="text-orange-500 font-bold mt-4">ğŸ† Top Scores</h3>
      <ol id="score-leaderboard"></ol>
    </div>

  </div>
  <div id="final-leaderboard" style="display:none; margin-top:20px;">
    <h2>ğŸ‰ Final Scores</h2>
    <ol id="final-scores"></ol>
  </div>
  <audio id="buzz-sound" src="/static/buzz.mp3" preload="auto"></audio>



  <script type="module">
    import { wsURL } from "/static/app.js";
    const sessionId = "{{ session_id }}";
    let teamName = null;
    let ws = null;

    document.getElementById('join').onclick = () => {
      teamName = document.getElementById('name').value.trim();
      if (!teamName) return alert("Enter team name");
      ws = new WebSocket(wsURL(`/ws/${sessionId}/player?name=${encodeURIComponent(teamName)}`));

      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        if (msg.type === "session_state") render(msg.data);
        if (msg.type === "error") {
          alert(msg.message);
          ws.close();
          ws = null;
        } else {
          // Success â†’ hide join form, show game area
          document.getElementById('join').style.display = 'none';
          document.getElementById('name').style.display = 'none';
          document.getElementById('game').style.display = '';
          document.getElementById('teamlabel').innerText = "Team: " + teamName;
        }
      };
    };

    document.getElementById('buzz').onclick = () => {
      ws.send(JSON.stringify({ type: "buzz" }));
      document.getElementById('buzz-sound').play();  // play sound on buzz
    };


    function render(state) {
      document.getElementById('buzz').disabled = !(state.open_for_buzz) || already || !!state.answered_correctly;
      // Change button color based on state
      const buzzBtn = document.getElementById('buzz');
      const already = (state.buzz_order || []).includes(teamName);
      const open = state.open_for_buzz && !already && !state.answered_correctly;

      buzzBtn.disabled = !open;

      // Colour states
      if (open) {
        buzzBtn.classList.add("bg-green-600", "text-white");
        buzzBtn.classList.remove("bg-red-600", "bg-gray-600");
      } else if (already || state.answered_correctly) {
        buzzBtn.classList.add("bg-gray-600", "text-white");
        buzzBtn.classList.remove("bg-green-600", "bg-red-600");
      } else {
        buzzBtn.classList.add("bg-red-600", "text-white");
        buzzBtn.classList.remove("bg-green-600", "bg-gray-600");
      }


      // --- Show player's own score
      if (state.teams[teamName]) {
        document.getElementById('hint').innerText = `Your score: ${state.teams[teamName].score}`;
      }

      // --- Fastest buzzers leaderboard (first 3 in queue)
      const buzzLb = document.getElementById('buzz-leaderboard');
      buzzLb.innerHTML = '';
      state.buzz_order.slice(0, 3).forEach(name => {
        const li = document.createElement('li');
        li.innerText = name;
        buzzLb.appendChild(li);
      });

      // --- Top scores leaderboard (top 3 teams by score)
      const scoreLb = document.getElementById('score-leaderboard');
      scoreLb.innerHTML = '';
      const sorted = Object.values(state.teams)
        .sort((a, b) => b.score - a.score)
        .slice(0, 3);
      sorted.forEach((team, idx) => {
        const li = document.createElement('li');
        li.innerText = `${team.name} (${team.score})`;
        scoreLb.appendChild(li);
      });

      // --- Extra context
      if (state.answered_correctly) {
        document.getElementById('hint').innerText += ` | âœ… ${state.answered_correctly} got it right!`;
      }
      // Question counter
      document.getElementById('question-counter').innerText =
        `Question ${state.question_idx + 1} of ${state.total_questions}`;

      // Final leaderboard
      const finalBox = document.getElementById('final-leaderboard');
      const finalList = document.getElementById('final-scores');
      if (state.question_idx + 1 === state.total_questions && !state.open_for_buzz) {
        finalBox.style.display = '';
        finalList.innerHTML = '';
        Object.values(state.teams)
          .sort((a, b) => b.score - a.score)
          .forEach(team => {
            const li = document.createElement('li');
            li.innerText = `${team.name}: ${team.score}`;
            finalList.appendChild(li);
          });
      } else {
        finalBox.style.display = 'none';
      }
    }
  </script>

</body>
</html>
