<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Player â€“ {{ session_id }}</title>
</head>
<body>
  <h1>Join Session {{ session_id }}</h1>
  <input id="name" placeholder="Team name" />
  <button id="join">Join</button>

  <div id="game" style="display:none;">
    <h2 id="teamlabel"></h2>
    <p id="question-counter"></p>
    <button id="buzz">Buzz!</button>
    <p id="hint">Waitingâ€¦</p>

    <h3>âš¡ Fastest Buzzers (this question)</h3>
    <ol id="buzz-leaderboard"></ol>

    <h3>ğŸ† Top Scores (round)</h3>
    <ol id="score-leaderboard"></ol>
  </div>
    <div id="final-leaderboard" style="display:none; margin-top:20px;">
    <h2>ğŸ‰ Final Scores</h2>
    <ol id="final-scores"></ol>
  </div>


  <script type="module">
    import { wsURL } from "/static/app.js";
    const sessionId = "{{ session_id }}";
    let teamName = null;
    let ws = null;

    document.getElementById('join').onclick = () => {
      teamName = document.getElementById('name').value.trim();
      if (!teamName) return alert("Enter team name");
      ws = new WebSocket(wsURL(`/ws/${sessionId}/player?name=${encodeURIComponent(teamName)}`));

      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        if (msg.type === "session_state") render(msg.data);
        if (msg.type === "error") {
          alert(msg.message);
          ws.close();
          ws = null;
        } else {
          // Success â†’ hide join form, show game area
          document.getElementById('join').style.display = 'none';
          document.getElementById('name').style.display = 'none';
          document.getElementById('game').style.display = '';
          document.getElementById('teamlabel').innerText = "Team: " + teamName;
        }
      };
    };

    document.getElementById('buzz').onclick = () => {
      ws.send(JSON.stringify({ type: "buzz" }));
    };

    function render(state) {
      const already = (state.buzz_order || []).includes(teamName);
      document.getElementById('buzz').disabled = !(state.open_for_buzz) || already || !!state.answered_correctly;

      // --- Show player's own score
      if (state.teams[teamName]) {
        document.getElementById('hint').innerText = `Your score: ${state.teams[teamName].score}`;
      }

      // --- Fastest buzzers leaderboard (first 3 in queue)
      const buzzLb = document.getElementById('buzz-leaderboard');
      buzzLb.innerHTML = '';
      state.buzz_order.slice(0, 3).forEach(name => {
        const li = document.createElement('li');
        li.innerText = name;
        buzzLb.appendChild(li);
      });

      // --- Top scores leaderboard (top 3 teams by score)
      const scoreLb = document.getElementById('score-leaderboard');
      scoreLb.innerHTML = '';
      const sorted = Object.values(state.teams)
        .sort((a, b) => b.score - a.score)
        .slice(0, 3);
      sorted.forEach((team, idx) => {
        const li = document.createElement('li');
        li.innerText = `${team.name} (${team.score})`;
        scoreLb.appendChild(li);
      });

      // --- Extra context
      if (state.answered_correctly) {
        document.getElementById('hint').innerText += ` | âœ… ${state.answered_correctly} got it right!`;
      }
      // Question counter
      document.getElementById('question-counter').innerText =
        `Question ${state.question_idx + 1} of ${state.total_questions}`;

      // Final leaderboard
      const finalBox = document.getElementById('final-leaderboard');
      const finalList = document.getElementById('final-scores');
      if (state.question_idx + 1 === state.total_questions && !state.open_for_buzz) {
        finalBox.style.display = '';
        finalList.innerHTML = '';
        Object.values(state.teams)
          .sort((a, b) => b.score - a.score)
          .forEach(team => {
            const li = document.createElement('li');
            li.innerText = `${team.name}: ${team.score}`;
            finalList.appendChild(li);
          });
      } else {
        finalBox.style.display = 'none';
      }
    }
  </script>

</body>
</html>
