<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Player – {{ session_id }}</title>
</head>
<body>
  <h1>Join Session {{ session_id }}</h1>
  <input id="name" placeholder="Team name" />
  <button id="join">Join</button>

  <div id="game" style="display:none;">
    <h2 id="teamlabel"></h2>
    <button id="buzz">Buzz!</button>
    <p id="hint">Waiting…</p>
  </div>

  <script type="module">
    import { wsURL } from "/static/app.js";
    const sessionId = "{{ session_id }}";
    let teamName = null;
    let ws = null;

    document.getElementById('join').onclick = () => {
      teamName = document.getElementById('name').value.trim();
      if (!teamName) return alert("Enter team name");
      ws = new WebSocket(wsURL(`/ws/${sessionId}/player?name=${encodeURIComponent(teamName)}`));

      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        if (msg.type === "session_state") render(msg.data);
        if (msg.type === "error") {
          alert(msg.message);
          ws.close();
          ws = null;
        } else {
          // Success → hide join form, show game area
          document.getElementById('join').style.display = 'none';
          document.getElementById('name').style.display = 'none';
          document.getElementById('game').style.display = '';
          document.getElementById('teamlabel').innerText = "Team: " + teamName;
        }
      };
    };

    document.getElementById('buzz').onclick = () => {
      ws.send(JSON.stringify({ type: "buzz" }));
    };

    function render(state) {
      const already = (state.buzz_order || []).includes(teamName);
      document.getElementById('buzz').disabled = !(state.open_for_buzz) || already || !!state.answered_correctly;

      // Show score
      if (state.teams[teamName]) {
        document.getElementById('hint').innerText = `Your score: ${state.teams[teamName].score}`;
      }

      if (state.answered_correctly) {
        document.getElementById('hint').innerText += ` | ✅ ${state.answered_correctly} got it right!`;
      }
    }
  </script>

</body>
</html>
